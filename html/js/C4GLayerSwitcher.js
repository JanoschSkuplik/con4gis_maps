OpenLayers.Control.C4GLayerSwitcher=OpenLayers.Class(OpenLayers.Control,{roundedCorner:false,roundedCornerColor:"darkblue",layerStates:null,layersDiv:null,baseLayersDiv:null,baseLayers:null,dataLbl:null,dataLayersDiv:null,dataLayers:null,minimizeDiv:null,maximizeDiv:null,ascending:true,dynaTree:null,initialize:function(a){a.displayClass="olControlLayerSwitcher";OpenLayers.Control.prototype.initialize.apply(this,arguments);this.layerStates=[];if(this.roundedCorner){OpenLayers.Console.warn('roundedCorner option is deprecated')}},destroy:function(){this.clearLayersArray("base");this.clearLayersArray("data");this.map.events.un({buttonclick:this.onButtonClick,addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this});this.events.unregister("buttonclick",this,this.onButtonClick);OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this});if(this.outsideViewport){this.events.attachToElement(this.div);this.events.register("buttonclick",this,this.onButtonClick)}else{this.map.events.register("buttonclick",this,this.onButtonClick)}},draw:function(){OpenLayers.Control.prototype.draw.apply(this);this.loadContents();if(!this.outsideViewport){this.minimizeControl()}this.redraw();return this.div},onButtonClick:function(a){var b=a.buttonElement;if(b===this.minimizeDiv){this.minimizeControl()}else if(b===this.maximizeDiv){this.maximizeControl()}else if(b._layerSwitcher===this.id){if(b["for"]){b=document.getElementById(b["for"])}if(!b.disabled){if(b.type=="radio"){b.checked=true;this.map.setBaseLayer(this.map.getLayer(b._layer))}else{b.checked=!b.checked;this.updateMap()}}}},clearLayersArray:function(a){this[a+"LayersDiv"].innerHTML="";this[a+"Layers"]=[]},checkRedraw:function(){var a=false;if(!this.layerStates.length||(this.map.layers.length!=this.layerStates.length)){a=true}else{for(var i=0,len=this.layerStates.length;i<len;i++){var b=this.layerStates[i];var c=this.map.layers[i];if((b.name!=c.name)||(b.inRange!=c.inRange)||(b.id!=c.id)||(b.visibility!=c.visibility)){a=true;break}}}return a},redraw:function(){if(!this.checkRedraw()){return this.div}this.clearLayersArray("base");this.clearLayersArray("data");var g=false;var h=false;var k=this.map.layers.length;this.layerStates=new Array(k);for(var i=0;i<k;i++){var l=this.map.layers[i];this.layerStates[i]={'name':l.name,'visibility':l.visibility,'inRange':l.inRange,'id':l.id}}var m=this.map.layers.slice();m.sort(function(a,b){var c=(a.sort?a.sort:0);var d=(b.sort?b.sort:0);return(c<d?-1:d<c?1:0)});if(!this.ascending){m.reverse()}var n=[];for(var i=0,k=m.length;i<k;i++){var l=m[i];var o=l.isBaseLayer;if(l.displayInLayerSwitcher&&!o){var p=n;if(l.parent){var q=function(a){for(var j=0;j<a.length;j++){if(a[j].key==l.parent){return a[j].children}var b=q(a[j].children);if(b)return b}return false};var r=q(n);if(r){p=r}}var s=false;if(this.dynaTree!=null){var t=this.dynaTree.getNodeByKey(l.key);if(t){s=t.bExpanded}}var u={title:l.name,icon:false,select:l.getVisibility(),expand:s,children:[],layer:l,key:l.key};p.push(u);g=true}if(l.displayInLayerSwitcher&&o){if(o){h=true}else{g=true}var v=(o)?(l==this.map.baseLayer):l.getVisibility();var w=document.createElement("input");w.id=this.id+"_input_"+l.name;w.name=(o)?this.id+"_baseLayers":l.name;w.type=(o)?"radio":"checkbox";w.value=l.name;w.checked=v;w.defaultChecked=v;w.className="olButton";w._layer=l.id;w._layerSwitcher=this.id;if(!o&&!l.inRange){w.disabled=true}var x=document.createElement("label");x["for"]=w.id;OpenLayers.Element.addClass(x,"labelSpan olButton");x._layer=l.id;x._layerSwitcher=this.id;if(!o&&!l.inRange){x.style.color="gray"}x.innerHTML=l.name;x.style.verticalAlign=(o)?"bottom":"baseline";var y=document.createElement("br");var z=(o)?this.baseLayers:this.dataLayers;z.push({'layer':l,'inputElem':w,'labelSpan':x});var A=(o)?this.baseLayersDiv:this.dataLayersDiv;A.appendChild(w);A.appendChild(x);A.appendChild(y)}}if(n.length>0){jQuery(this.dataLayersDiv).dynatree({onSelect:function(c,d){if(d.data.layer){var e=function(a){if(d.bSelected){var b=a.map.layers.length-1;while(a.map.layers[b]instanceof OpenLayers.Layer.Vector.RootContainer){b--}a.map.setLayerIndex(a,b)}};e(d.data.layer);d.data.layer.setVisibility(d.bSelected);var f=function(a){if(typeof(a)=='object'){for(var i=0;i<a.length;i++){e(a[i]);a[i].setVisibility(d.bSelected);f(a[i].children)}}};f(d.data.layer.children)}},onClick:function(a,b){if(a.getEventTargetType(b)=="title"){a.toggleSelect()}},onKeydown:function(a,b){if(b.which==32){a.toggleSelect();return false}},checkbox:true,selectMode:3,children:n});this.dynaTree=jQuery(this.dataLayersDiv).dynatree("getTree");this.dynaTree.reload()}this.dataLbl.style.display=(g)?"":"none";this.baseLbl.style.display=(h)?"":"none";this.keepEvents(this.layersDiv);return this.div},updateMap:function(){for(var i=0,len=this.baseLayers.length;i<len;i++){var a=this.baseLayers[i];if(a.inputElem.checked){this.map.setBaseLayer(a.layer,false)}}for(var i=0,len=this.dataLayers.length;i<len;i++){var a=this.dataLayers[i];a.layer.setVisibility(a.inputElem.checked)}},maximizeControl:function(e){this.div.style.width="";this.div.style.height="";this.div.style['border']='';this.showControls(false);if(e!=null){OpenLayers.Event.stop(e)}},minimizeControl:function(e){this.div.style.width="0px";this.div.style.height="0px";this.div.style['border']='none';this.showControls(true);if(e!=null){OpenLayers.Event.stop(e)}},showControls:function(a){this.maximizeDiv.style.display=a?"":"none";this.minimizeDiv.style.display=a?"none":"";this.layersDiv.style.display=a?"none":""},loadContents:function(){this.layersDiv=document.createElement("div");this.layersDiv.id=this.id+"_layersDiv";OpenLayers.Element.addClass(this.layersDiv,"layersDiv");this.baseLbl=document.createElement("div");this.baseLbl.innerHTML=OpenLayers.i18n("Base Layer");OpenLayers.Element.addClass(this.baseLbl,"baseLbl");this.baseLayersDiv=document.createElement("div");OpenLayers.Element.addClass(this.baseLayersDiv,"baseLayersDiv");this.dataLbl=document.createElement("div");this.dataLbl.innerHTML=OpenLayers.i18n("Overlays");OpenLayers.Element.addClass(this.dataLbl,"dataLbl");this.dataLayersDiv=document.createElement("div");OpenLayers.Element.addClass(this.dataLayersDiv,"dataLayersDiv");if(this.ascending){this.layersDiv.appendChild(this.baseLbl);this.layersDiv.appendChild(this.baseLayersDiv);this.layersDiv.appendChild(this.dataLbl);this.layersDiv.appendChild(this.dataLayersDiv)}else{this.layersDiv.appendChild(this.dataLbl);this.layersDiv.appendChild(this.dataLayersDiv);this.layersDiv.appendChild(this.baseLbl);this.layersDiv.appendChild(this.baseLayersDiv)}this.div.appendChild(this.layersDiv);if(this.roundedCorner){OpenLayers.Rico.Corner.round(this.div,{corners:"tl bl",bgColor:"transparent",color:this.roundedCornerColor,blend:false});OpenLayers.Rico.Corner.changeOpacity(this.layersDiv,0.75)}var a=OpenLayers.Util.getImageLocation('starboard-maximize.png');this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MaximizeDiv",null,null,a,"absolute");OpenLayers.Element.addClass(this.maximizeDiv,"maximizeDiv olButton");this.maximizeDiv.style.display="none";this.div.appendChild(this.maximizeDiv);var a=OpenLayers.Util.getImageLocation('layer-switcher-minimize.png');this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MinimizeDiv",null,null,a,"absolute");OpenLayers.Element.addClass(this.minimizeDiv,"minimizeDiv olButton");this.minimizeDiv.style.display="none";this.div.appendChild(this.minimizeDiv)},keepEvents:function(b){this.keepEventsDiv=new OpenLayers.Events(this,b,null,true);var c={"touchstart":function(a){OpenLayers.Event.stop(a,true)}};this.keepEventsDiv.on(c)},CLASS_NAME:"OpenLayers.Control.C4GLayerSwitcher"});